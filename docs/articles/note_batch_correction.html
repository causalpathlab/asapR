<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Batch correction within each pseudobulk sample â€¢ asapR</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Batch correction within each pseudobulk sample">
<meta property="og:description" content="asapR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">asapR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/note_batch_correction.html">Batch correction within each pseudobulk sample</a>
    </li>
    <li>
      <a href="../articles/note_faster_nmf_approximation.html">Expedite Poisson-NMF estimation via alternating regression models</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Batch correction within each pseudobulk sample</h1>
                        <h4 data-toc-skip class="author">Yongjin Park</h4>
            
      
      
      <div class="hidden name"><code>note_batch_correction.Rmd</code></div>

    </div>

    
    
<div class="section level3">
<h3 id="a-generative-scheme-for-a-single-cell-count-matrix-with-multiplicative-batch-effects">A generative scheme for a single-cell count matrix with multiplicative batch effects<a class="anchor" aria-label="anchor" href="#a-generative-scheme-for-a-single-cell-count-matrix-with-multiplicative-batch-effects"></a>
</h3>
<p>We encounter single-cell expression data consisting of multiple batches. One of the primary goals is to identify cell types (clusters/factors) and cell-type-specific gene expression patterns. However, distinguishing batch-specific and cell-type-specific genes only by a factorization method is challenging and often not identifiable from data alone. For each gene <span class="math inline">\(g\)</span> and cell <span class="math inline">\(j\)</span>, the gene expression <span class="math inline">\(Y_{gj}\)</span> were sampled from Poisson distribution with the rate parameter:</p>
<p><span class="math display">\[\lambda_{gj} = \lambda_{gj}^{\textsf{unbiased}} \times \prod_{k} \delta_{gk}^{X_{kj}},\]</span></p>
<p>affected by the batch effects <span class="math inline">\(\delta_{gk}\)</span>. More formally, letting <span class="math inline">\(X_{kj}\)</span> be a batch membership matrix, assigning a cell <span class="math inline">\(j\)</span> to a batch <span class="math inline">\(k\)</span> if and only if <span class="math inline">\(X_{kj}=1\)</span>, we assume the average gene expression rates are linearly affected by in the log-transformed space:</p>
<p><span class="math display">\[\mathbb{E}\!\left[\ln Y_{gj}\right] = \ln \left( \sum_{t} \beta_{gt} \theta_{jt} \right) + \sum_{k} \ln\delta_{gk} X_{kj}.\]</span></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1331</span><span class="op">)</span>

<span class="va">m</span> <span class="op">&lt;-</span> <span class="fl">500</span> <span class="co"># genes</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1000</span> <span class="co"># cells</span>

<span class="va">nb</span> <span class="op">&lt;-</span> <span class="fl">2</span>
<span class="va">mb</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="co"># batch specific genes</span>

<span class="co">## 1. batch membership</span>
<span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span>, <span class="va">nb</span><span class="op">)</span>
<span class="va">batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">nb</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">b</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nb</span><span class="op">)</span><span class="op">{</span>
    <span class="va">X</span><span class="op">[</span><span class="va">batch</span> <span class="op">==</span> <span class="va">b</span>, <span class="va">b</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="op">}</span>

<span class="co">## 2. batch effects</span>
<span class="va">W.true</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">m</span><span class="op">*</span><span class="va">nb</span><span class="op">)</span>, <span class="va">m</span>, <span class="va">nb</span><span class="op">)</span>
<span class="va">ln.delta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">W.true</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="fl">2</span>, <span class="va">scale</span><span class="op">)</span>

<span class="co">## 3. true effects</span>
<span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">5</span>
<span class="va">.beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="va">m</span> <span class="op">*</span> <span class="va">K</span>, <span class="fl">1</span><span class="op">)</span>, <span class="va">m</span>, <span class="va">K</span><span class="op">)</span>
<span class="va">.theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">K</span>, <span class="fl">1</span><span class="op">)</span>, <span class="va">n</span>, <span class="va">K</span><span class="op">)</span>
<span class="va">lambda.true</span> <span class="op">&lt;-</span> <span class="va">.beta</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">.theta</span><span class="op">)</span>

<span class="va">lambda</span> <span class="op">&lt;-</span> <span class="va">lambda.true</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">ln.delta</span><span class="op">)</span>
<span class="va">yy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">lambda</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">l</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">l</span>, <span class="va">rpois</span>, n<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">oo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">.theta</span><span class="op">)</span>, <span class="fl">2</span>, <span class="va">which.max</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>If we can accurately estimate a true batch effect matrix, say <span class="math inline">\(\delta_{gk}\)</span>, it is straightforward to adjust the difference between batches. How can we identify the true batch effect <span class="math inline">\(\delta_{gk}\)</span> for all the genes <span class="math inline">\(g\)</span> specifically expressed in the batch <span class="math inline">\(k\)</span>? If we match cells <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> sampled from the batches <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span>, respectively, we expect the batch-specific difference <span class="math inline">\(\delta_{ga} \neq \delta_{gk}\)</span> will persist and even amplify, but the difference originated from cell types will vanish. This problem is equivalent to estimating the potential outcome of gene expressions in each batch <span class="math inline">\(k\)</span>, <span class="math inline">\(\mathbb{E}\!\left[Y_{gj}^{(k)}\right]\)</span>.</p>
</div>
<div class="section level3">
<h3 id="a-causal-inference-approach-to-identify-batch-effects">A causal inference approach to identify batch effects<a class="anchor" aria-label="anchor" href="#a-causal-inference-approach-to-identify-batch-effects"></a>
</h3>
<ul>
<li><p>Overlap: <span class="math inline">\(0 &lt; p(X_{jk}=1|Q) &lt; 1\)</span> for all <span class="math inline">\(k\)</span>.</p></li>
<li><p>Conditional unconfoundedness: <span class="math inline">\(Y^{(k)} \perp Y^{(k')} | Q\)</span> for all <span class="math inline">\(k,k'\)</span> pairs.</p></li>
</ul>
<p>We assume that the orignal random projection matrix <span class="math inline">\(Q\)</span> sufficiently explaining factors that confound the batch assignments and observed gene expressions.</p>
<p><span class="math display">\[\mathbb{E}\!\left[ \mathbb{E}\!\left[Y | Q \right] \right]\]</span></p>
<p><span class="math display">\[\mathbb{E}\!\left[Y_{gj}, X_{kj} = 1| Q\right]\]</span></p>
<ul>
<li><p>Match cells across different batches (within each stratum)</p></li>
<li><p>Estimate shared <span class="math inline">\(\mu\)</span> and batch-specific effects <span class="math inline">\(\delta\)</span></p></li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## 1. project</span>
<span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">5</span>
<span class="va">R</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">m</span> <span class="op">*</span> <span class="va">K</span><span class="op">)</span>, <span class="va">K</span>, <span class="va">m</span><span class="op">)</span>
<span class="va">Q.raw</span> <span class="op">&lt;-</span> <span class="va">R</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">yy</span> <span class="co"># K x n</span></code></pre></div>
<p>Before we adjust batch membership in the random projection matrix:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">Q.raw</span><span class="op">)</span>, <span class="va">X</span><span class="op">)</span></code></pre></div>
<pre><code>       [,1]       [,2]</code></pre>
<p>[1,] 0.7617260 -0.7617260 [2,] 0.8283630 -0.8283630 [3,] 0.8099248 -0.8099248 [4,] -0.7250199 0.7250199 [5,] 0.6651915 -0.6651915</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## 2. regress out</span>
<span class="co">##</span>
<span class="co">##  X theta = X inv(X'X) X' Y</span>
<span class="co">##          = U D V' V inv(D^2) V' (U D V')' Y</span>
<span class="co">##          = U inv(D) V' V D U' Y</span>
<span class="co">##          = U U' Y</span>

<span class="va">x.svd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/svd.html" class="external-link">svd</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>
<span class="va">U</span> <span class="op">&lt;-</span> <span class="va">x.svd</span><span class="op">$</span><span class="va">u</span>
<span class="va">U.t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">x.svd</span><span class="op">$</span><span class="va">u</span><span class="op">)</span>

<span class="va">Q.t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">Q.raw</span><span class="op">)</span>
<span class="va">Q.t</span> <span class="op">&lt;-</span> <span class="va">Q.t</span> <span class="op">-</span> <span class="va">U</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">U.t</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">Q.t</span>
<span class="va">Q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">Q.t</span><span class="op">)</span></code></pre></div>
<p>After we adjust the batch effects:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">Q.t</span>, <span class="va">X</span><span class="op">)</span></code></pre></div>
<pre><code>          [,1]          [,2]</code></pre>
<p>[1,] -2.732905e-16 2.732905e-16 [2,] -5.801340e-16 5.801340e-16 [3,] -2.653637e-16 2.653637e-16 [4,] 3.783374e-16 -3.783374e-16 [5,] -2.732729e-16 2.732729e-16</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">q.svd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/svd.html" class="external-link">svd</a></span><span class="op">(</span><span class="va">Q</span><span class="op">)</span>

<span class="co">## 3. sorting</span>
<span class="va">B</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sign.html" class="external-link">sign</a></span><span class="op">(</span><span class="va">q.svd</span><span class="op">$</span><span class="va">v</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span>
<span class="va">ss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sweep.html" class="external-link">sweep</a></span><span class="op">(</span><span class="va">B</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">^</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">K</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="va">`*`</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">feat.dn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">Q</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">knn</span> <span class="op">&lt;-</span> <span class="fl">3</span>
<span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">feat.dn</span><span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/eddelbuettel/rcppannoy" class="external-link">RcppAnnoy</a></span><span class="op">)</span>
<span class="co">## a. construct dictionary for each batch</span>
<span class="va">dict.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">batch</span><span class="op">)</span><span class="op">)</span>,
                    <span class="kw">function</span><span class="op">(</span><span class="va">b</span><span class="op">)</span> <span class="op">{</span> <span class="fu">new</span><span class="op">(</span><span class="va">AnnoyAngular</span>, <span class="va">d</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span>

<span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">batch</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="va">b</span> <span class="op">&lt;-</span> <span class="va">batch</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>
    <span class="va">dict.list</span><span class="op">[[</span><span class="va">b</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">addItem</span><span class="op">(</span><span class="va">j</span>, <span class="va">feat.dn</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span><span class="op">)</span>
<span class="op">}</span>

<span class="kw">for</span><span class="op">(</span><span class="va">dd</span> <span class="kw">in</span> <span class="va">dict.list</span><span class="op">)</span><span class="op">{</span>
    <span class="va">dd</span><span class="op">$</span><span class="fu">build</span><span class="op">(</span><span class="fl">50</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">## b. a simplified routine to retrieve and estimate counterfactual y</span>
<span class="va">.counterfactual</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">j</span><span class="op">)</span><span class="op">{</span>
    <span class="va">v</span> <span class="op">&lt;-</span> <span class="va">feat.dn</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span>

    <span class="va">nn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>
    <span class="va">dd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>

    <span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nb</span><span class="op">)</span><span class="op">{</span>
        <span class="kw">if</span><span class="op">(</span><span class="va">k</span> <span class="op">==</span> <span class="va">batch</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span> <span class="kw">next</span>
        <span class="va">.nn</span> <span class="op">&lt;-</span> <span class="va">dict.list</span><span class="op">[[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">getNNsByVector</span><span class="op">(</span><span class="va">v</span>, <span class="va">knn</span><span class="op">)</span>
        <span class="va">.dd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">feat.dn</span><span class="op">[</span>, <span class="va">.nn</span><span class="op">]</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">u</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">u</span> <span class="op">-</span> <span class="va">v</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>
        <span class="va">nn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">nn</span>, <span class="va">.nn</span><span class="op">)</span>
        <span class="va">dd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">dd</span>, <span class="va">.dd</span><span class="op">)</span>
    <span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">nn</span><span class="op">)</span>

    <span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">dd</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dd</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="va">w</span> <span class="op">&lt;-</span> <span class="va">w</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span>

    <span class="va">yy</span><span class="op">[</span>, <span class="va">nn</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">w</span>, ncol<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ngene</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">yy</span><span class="op">)</span>
<span class="va">nbatch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>
<span class="va">nsample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">ss</span><span class="op">)</span>

<span class="va">.delta.db</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">ngene</span>, <span class="va">nbatch</span><span class="op">)</span>       <span class="co"># gene x batch effects</span>
<span class="va">.delta.num.db</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">ngene</span>, <span class="va">nbatch</span><span class="op">)</span>    <span class="co"># gene x batch numerators</span>
<span class="va">.delta.denom.db</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">ngene</span>, <span class="va">nbatch</span><span class="op">)</span>  <span class="co"># gene x batch denominators</span>

<span class="va">.prob.bs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">nbatch</span>, <span class="va">nsample</span><span class="op">)</span>      <span class="co"># batch x sample probabilities</span>
<span class="va">.size.bs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">nbatch</span>, <span class="va">nsample</span><span class="op">)</span>      <span class="co"># batch x sample freq</span>
<span class="va">.ybar.ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">ngene</span>, <span class="va">nsample</span><span class="op">)</span>       <span class="co"># gene x sample observed average</span>
<span class="va">.zbar.ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">ngene</span>, <span class="va">nsample</span><span class="op">)</span>       <span class="co"># gene x sample imputed average</span>
<span class="va">.mu.ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">ngene</span>, <span class="va">nsample</span><span class="op">)</span>         <span class="co"># gene x sample adjusted average</span>

<span class="co">## Precalculate some statistics</span>
<span class="kw">for</span><span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nsample</span><span class="op">)</span><span class="op">{</span>
    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ss</span> <span class="op">==</span> <span class="va">s</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1</span><span class="op">)</span> <span class="kw">next</span>

    <span class="va">.yy</span> <span class="op">&lt;-</span> <span class="va">yy</span><span class="op">[</span>, <span class="va">ss</span> <span class="op">==</span> <span class="va">s</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>
    <span class="va">.zz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">ss</span> <span class="op">==</span> <span class="va">s</span><span class="op">)</span>, <span class="va">.counterfactual</span><span class="op">)</span><span class="op">)</span>

    <span class="va">.ybar.ds</span><span class="op">[</span>,<span class="va">s</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">.yy</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span>
    <span class="va">.zbar.ds</span><span class="op">[</span>,<span class="va">s</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">.zz</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span>
    <span class="va">.prob.bs</span><span class="op">[</span>,<span class="va">s</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span><span class="va">ss</span> <span class="op">==</span> <span class="va">s</span>, <span class="op">]</span><span class="op">)</span>
    <span class="va">.size.bs</span><span class="op">[</span>,<span class="va">s</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span><span class="va">ss</span> <span class="op">==</span> <span class="va">s</span>, <span class="op">]</span><span class="op">)</span>

    <span class="va">.y.dsb</span> <span class="op">&lt;-</span> <span class="va">yy</span><span class="op">[</span>, <span class="va">ss</span> <span class="op">==</span> <span class="va">s</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">X</span><span class="op">[</span><span class="va">ss</span> <span class="op">==</span> <span class="va">s</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>
    <span class="va">.delta.num.db</span> <span class="op">&lt;-</span> <span class="va">.delta.num.db</span> <span class="op">+</span> <span class="va">.y.dsb</span>
<span class="op">}</span></code></pre></div>
<pre><code><span class="co">## [1] 650 531 221</span>
<span class="co">## [1] 324 670 791</span>
<span class="co">## [1] 204 295 215</span>
<span class="co">## [1] 160 221 678</span>
<span class="co">## [1] 329  38  16</span>
<span class="co">## [1] 514 428 387</span>
<span class="co">## [1] 538 215 126</span>
<span class="co">## [1] 622 815 397</span>
<span class="co">## [1] 581 324 791</span>
<span class="co">## [1] 514 257 549</span>
<span class="co">## [1] 324 670 329</span>
<span class="co">## [1] 650 324 670</span>
<span class="co">## [1] 531 160 221</span>
<span class="co">## [1] 581 329 493</span>
<span class="co">## [1] 329 285 436</span>
<span class="co">## [1] 903 984 794</span>
<span class="co">## [1] 329 581 493</span>
<span class="co">## [1] 397 769 903</span>
<span class="co">## [1] 903 984 794</span>
<span class="co">## [1] 514 842 397</span>
<span class="co">## [1] 329 581  16</span>
<span class="co">## [1] 581 329 493</span>
<span class="co">## [1] 581 493 329</span>
<span class="co">## [1] 670 650 324</span>
<span class="co">## [1] 204 295 794</span>
<span class="co">## [1] 622 842 741</span>
<span class="co">## [1] 324 650 656</span>
<span class="co">## [1] 531 656 650</span>
<span class="co">## [1] 581 329 493</span>
<span class="co">## [1] 160 172 221</span>
<span class="co">## [1] 948 314 655</span>
<span class="co">## [1] 948 314 775</span>
<span class="co">## [1] 948 917 314</span>
<span class="co">## [1] 917 652 314</span>
<span class="co">## [1] 948 314 655</span>
<span class="co">## [1] 948 314 415</span>
<span class="co">## [1] 680 221 650</span>
<span class="co">## [1] 917 948 221</span>
<span class="co">## [1] 948 314 425</span>
<span class="co">## [1] 948 314 775</span>
<span class="co">## [1] 680 299  97</span>
<span class="co">## [1] 948 314 655</span>
<span class="co">## [1] 828 570 574</span>
<span class="co">## [1] 948 917 314</span>
<span class="co">## [1] 636 440 291</span>
<span class="co">## [1] 680 283 704</span>
<span class="co">## [1] 221 160 718</span>
<span class="co">## [1] 917 221 499</span>
<span class="co">## [1] 948 314 655</span>
<span class="co">## [1] 948 314 521</span>
<span class="co">## [1] 283 338 826</span>
<span class="co">## [1] 221 704 718</span>
<span class="co">## [1] 917 948 425</span>
<span class="co">## [1] 680 299 650</span>
<span class="co">## [1] 314 948 775</span>
<span class="co">## [1] 948 917 425</span>
<span class="co">## [1] 314 948 521</span>
<span class="co">## [1] 917 221 718</span>
<span class="co">## [1] 299 680  97</span>
<span class="co">## [1] 314 948 521</span>
<span class="co">## [1] 948 425 917</span>
<span class="co">## [1] 221 718 917</span>
<span class="co">## [1] 521 652 960</span>
<span class="co">## [1] 314 948 521</span>
<span class="co">## [1] 314 948 775</span>
<span class="co">## [1] 521 314 960</span>
<span class="co">## [1] 221 917 718</span>
<span class="co">## [1] 521 917 314</span>
<span class="co">## [1] 917 425 568</span>
<span class="co">## [1] 521 314 948</span>
<span class="co">## [1] 948 917 425</span>
<span class="co">## [1] 948 314 775</span>
<span class="co">## [1] 960 811 521</span>
<span class="co">## [1] 917 221 651</span>
<span class="co">## [1] 425 948 314</span>
<span class="co">## [1] 283 338 948</span>
<span class="co">## [1] 689 221 665</span>
<span class="co">## [1] 322 536 483</span>
<span class="co">## [1] 294 295 514</span>
<span class="co">## [1] 581 493 329</span>
<span class="co">## [1] 294 514 128</span>
<span class="co">## [1] 536 322 131</span>
<span class="co">## [1] 322 320 536</span>
<span class="co">## [1] 322 294 178</span>
<span class="co">## [1] 122 436 448</span>
<span class="co">## [1] 320 252 322</span>
<span class="co">## [1] 294 475 514</span>
<span class="co">## [1] 294 514 167</span>
<span class="co">## [1] 320 322 779</span>
<span class="co">## [1] 322 320 779</span>
<span class="co">## [1] 322 779 483</span>
<span class="co">## [1] 320 322 128</span>
<span class="co">## [1] 356 482 391</span>
<span class="co">## [1] 320 322 128</span>
<span class="co">## [1] 320 128 322</span>
<span class="co">## [1] 320 322 904</span>
<span class="co">## [1] 536 236 483</span>
<span class="co">## [1] 536 236 394</span>
<span class="co">## [1] 394 536 538</span>
<span class="co">## [1] 294 419 475</span>
<span class="co">## [1] 322 536 320</span>
<span class="co">## [1] 322 536 178</span>
<span class="co">## [1] 322 536 294</span>
<span class="co">## [1] 314 697 242</span>
<span class="co">## [1] 738 763 744</span>
<span class="co">## [1] 322 320  15</span>
<span class="co">## [1] 787 937 819</span>
<span class="co">## [1] 535 249 886</span>
<span class="co">## [1] 338 283 649</span>
<span class="co">## [1] 314 948 242</span>
<span class="co">## [1] 819 252 904</span>
<span class="co">## [1] 948 242 697</span>
<span class="co">## [1] 252 904 819</span>
<span class="co">## [1]  92 948 338</span>
<span class="co">## [1] 521 811 826</span>
<span class="co">## [1] 608 580 489</span>
<span class="co">## [1] 738 563 236</span>
<span class="co">## [1] 252 904  15</span>
<span class="co">## [1] 580 608 153</span>
<span class="co">## [1] 349 326 246</span>
<span class="co">## [1] 992 186 990</span>
<span class="co">## [1] 574 842 990</span>
<span class="co">## [1] 560 246 349</span>
<span class="co">## [1] 992 574 622</span>
<span class="co">## [1] 560 246 458</span>
<span class="co">## [1] 930 284 305</span>
<span class="co">## [1] 246 301 764</span>
<span class="co">## [1] 560 808 246</span>
<span class="co">## [1] 246 349 326</span>
<span class="co">## [1] 992 574 622</span>
<span class="co">## [1] 622 349 574</span>
<span class="co">## [1] 947 496  71</span>
<span class="co">## [1] 560 246 817</span>
<span class="co">## [1] 626 267 246</span>
<span class="co">## [1] 939 365 786</span>
<span class="co">## [1] 246 841 349</span>
<span class="co">## [1] 622 741 780</span>
<span class="co">## [1] 581 604 493</span>
<span class="co">## [1] 581 604 284</span>
<span class="co">## [1] 349 780 622</span>
<span class="co">## [1] 622 349 780</span>
<span class="co">## [1] 992 574 465</span>
<span class="co">## [1] 465 574 992</span>
<span class="co">## [1] 992 574 465</span>
<span class="co">## [1] 949 992 461</span>
<span class="co">## [1] 883 266 808</span>
<span class="co">## [1] 590 800 871</span>
<span class="co">## [1] 574 992 465</span>
<span class="co">## [1] 465 669 461</span>
<span class="co">## [1] 461 992 465</span>
<span class="co">## [1] 574 992 465</span>
<span class="co">## [1] 521 314 389</span>
<span class="co">## [1] 574 465 596</span>
<span class="co">## [1] 883 808 258</span>
<span class="co">## [1] 465 309 628</span>
<span class="co">## [1]  39 281 582</span>
<span class="co">## [1] 465 309 628</span>
<span class="co">## [1] 461 992 465</span>
<span class="co">## [1] 628 949 309</span>
<span class="co">## [1] 465 628 800</span>
<span class="co">## [1] 560 127 883</span>
<span class="co">## [1] 560 883 458</span>
<span class="co">## [1]  77 646 190</span>
<span class="co">## [1] 686 604 298</span>
<span class="co">## [1] 604 241 686</span>
<span class="co">## [1] 745 626 258</span>
<span class="co">## [1]  77 190 383</span>
<span class="co">## [1] 686 298 604</span>
<span class="co">## [1] 749 737 258</span>
<span class="co">## [1] 604 241 581</span>
<span class="co">## [1] 604 329 241</span>
<span class="co">## [1] 298 686 105</span>
<span class="co">## [1] 904 320  15</span>
<span class="co">## [1] 320  77 190</span>
<span class="co">## [1] 298 686 786</span>
<span class="co">## [1] 604 581 493</span>
<span class="co">## [1] 604 298 686</span>
<span class="co">## [1] 904 128 391</span>
<span class="co">## [1]  46 145 886</span>
<span class="co">## [1] 686 604 298</span>
<span class="co">## [1] 691 686 885</span>
<span class="co">## [1] 391 144 613</span>
<span class="co">## [1] 604 241 581</span>
<span class="co">## [1] 604 581 493</span>
<span class="co">## [1] 604 691 241</span>
<span class="co">## [1] 105  17 298</span>
<span class="co">## [1] 298 752 691</span>
<span class="co">## [1] 604 686 610</span>
<span class="co">## [1]  84 620 209</span>
<span class="co">## [1] 904 320  15</span>
<span class="co">## [1] 686 691 298</span>
<span class="co">## [1] 604 686 610</span>
<span class="co">## [1] 604 686 298</span>
<span class="co">## [1] 613 267 423</span>
<span class="co">## [1] 419 619 391</span>
<span class="co">## [1] 145 100  46</span>
<span class="co">## [1] 391 383 951</span>
<span class="co">## [1] 252 904 320</span>
<span class="co">## [1] 560 843 817</span>
<span class="co">## [1]  46 145 786</span>
<span class="co">## [1] 298 145 686</span>
<span class="co">## [1] 686 298 878</span>
<span class="co">## [1] 878 786 298</span>
<span class="co">## [1] 895 142 383</span>
<span class="co">## [1] 581 493 241</span>
<span class="co">## [1] 581 493 604</span>
<span class="co">## [1] 241 604 610</span>
<span class="co">## [1] 320 904  15</span>
<span class="co">## [1]  77 320 502</span>
<span class="co">## [1] 229 489 968</span>
<span class="co">## [1] 407 886 497</span>
<span class="co">## [1] 407 878 902</span>
<span class="co">## [1] 548 523 199</span>
<span class="co">## [1] 489 637 968</span>
<span class="co">## [1] 134 625 853</span>
<span class="co">## [1] 192 242 273</span>
<span class="co">## [1]  15 904 482</span>
<span class="co">## [1] 886 373  46</span>
<span class="co">## [1] 523 710 548</span>
<span class="co">## [1] 646 904 252</span>
<span class="co">## [1] 710 134 302</span>
<span class="co">## [1]  15 646 904</span>
<span class="co">## [1] 675 147 931</span>
<span class="co">## [1] 646  15 904</span>
<span class="co">## [1] 646 931 569</span>
<span class="co">## [1] 886 407 497</span>
<span class="co">## [1] 242 697 192</span>
<span class="co">## [1] 489 229 535</span>
<span class="co">## [1] 154  15 871</span>
<span class="co">## [1] 273 352 153</span>
<span class="co">## [1] 637 728 407</span>
<span class="co">## [1] 153 273 352</span>
<span class="co">## [1] 637 407 728</span>
<span class="co">## [1] 920 804 548</span>
<span class="co">## [1] 886 407 489</span>
<span class="co">## [1] 804 819 548</span>
<span class="co">## [1] 646 904 320</span>
<span class="co">## [1] 407 855 624</span>
<span class="co">## [1] 640 658 372</span>
<span class="co">## [1] 352 192 273</span>
<span class="co">## [1] 877 273  80</span>
<span class="co">## [1] 580 608 273</span>
<span class="co">## [1] 871 154 673</span>
<span class="co">## [1] 407 728 637</span>
<span class="co">## [1] 407 995 728</span>
<span class="co">## [1] 192 242 697</span>
<span class="co">## [1] 489 811 273</span>
<span class="co">## [1] 592 266 904</span>
<span class="co">## [1] 675 904  15</span>
<span class="co">## [1] 637 407 640</span>
<span class="co">## [1] 614 897 185</span>
<span class="co">## [1] 407 494 897</span>
<span class="co">## [1] 177 497 855</span>
<span class="co">## [1] 796 117 946</span>
<span class="co">## [1] 531 109 194</span>
<span class="co">## [1] 210 656 531</span>
<span class="co">## [1] 460 689 484</span>
<span class="co">## [1] 493 581 329</span>
<span class="co">## [1] 990 187 796</span>
<span class="co">## [1] 990 992 796</span>
<span class="co">## [1] 117 295 984</span>
<span class="co">## [1]  74 946 841</span>
<span class="co">## [1] 581 493 162</span>
<span class="co">## [1] 581 493 329</span>
<span class="co">## [1] 431 863 946</span>
<span class="co">## [1] 493 581 329</span>
<span class="co">## [1] 581 493 329</span>
<span class="co">## [1] 493  16 173</span>
<span class="co">## [1] 581 493 162</span>
<span class="co">## [1] 117 405 295</span>
<span class="co">## [1] 493 581 162</span>
<span class="co">## [1] 117 295 984</span>
<span class="co">## [1] 581 493 329</span>
<span class="co">## [1] 117 295 507</span>
<span class="co">## [1] 117 796 984</span>
<span class="co">## [1] 581 493 329</span>
<span class="co">## [1] 493 581 329</span>
<span class="co">## [1] 689 160  57</span>
<span class="co">## [1] 295 984 204</span>
<span class="co">## [1] 417 210 656</span>
<span class="co">## [1] 493 581 162</span>
<span class="co">## [1] 531 656 417</span>
<span class="co">## [1] 313 461 679</span>
<span class="co">## [1] 425 651 917</span>
<span class="co">## [1] 283 948 338</span>
<span class="co">## [1] 172  78  57</span>
<span class="co">## [1] 992 828 990</span>
<span class="co">## [1] 948 655 775</span>
<span class="co">## [1] 704 665 194</span>
<span class="co">## [1]  40 172 917</span>
<span class="co">## [1]  40 651 415</span>
<span class="co">## [1] 318 415 533</span>
<span class="co">## [1] 898 916 214</span>
<span class="co">## [1] 309 669 916</span>
<span class="co">## [1] 948 917 651</span>
<span class="co">## [1] 917 425 651</span>
<span class="co">## [1] 651 917  40</span>
<span class="co">## [1] 338 948 283</span>
<span class="co">## [1] 718 221 102</span>
<span class="co">## [1] 948 655 415</span>
<span class="co">## [1] 272 898 218</span>
<span class="co">## [1] 283 338  92</span>
<span class="co">## [1] 245 564 395</span>
<span class="co">## [1] 295 322 294</span>
<span class="co">## [1] 493 162 331</span>
<span class="co">## [1] 178 779 322</span>
<span class="co">## [1] 295 204 507</span>
<span class="co">## [1] 178 294 322</span>
<span class="co">## [1] 252 128 904</span>
<span class="co">## [1] 178 322 128</span>
<span class="co">## [1] 295 424 294</span>
<span class="co">## [1] 578 507 368</span>
<span class="co">## [1] 924 434 209</span>
<span class="co">## [1] 747 727 712</span>
<span class="co">## [1] 295 204 424</span>
<span class="co">## [1] 505 910 705</span>
<span class="co">## [1] 295 322 536</span>
<span class="co">## [1] 295 322 178</span>
<span class="co">## [1] 143 471  26</span>
<span class="co">## [1] 128 320 857</span>
<span class="co">## [1] 252 904 128</span>
<span class="co">## [1] 294  26 424</span>
<span class="co">## [1] 405 128 814</span>
<span class="co">## [1] 322 483 779</span>
<span class="co">## [1] 295 507 117</span>
<span class="co">## [1] 320 322 128</span>
<span class="co">## [1] 295 507 117</span>
<span class="co">## [1] 295 507 215</span>
<span class="co">## [1] 128 294 178</span>
<span class="co">## [1] 128 178 322</span>
<span class="co">## [1] 295 507 536</span>
<span class="co">## [1] 252 320 779</span>
<span class="co">## [1] 295 294 178</span>
<span class="co">## [1] 322 178 295</span>
<span class="co">## [1] 405 424  26</span>
<span class="co">## [1] 252 320 322</span>
<span class="co">## [1] 295 507 204</span>
<span class="co">## [1] 295 424 507</span>
<span class="co">## [1] 295 536 507</span>
<span class="co">## [1] 236 483 536</span>
<span class="co">## [1] 607 368 551</span>
<span class="co">## [1] 252 904 236</span>
<span class="co">## [1] 252 236 819</span>
<span class="co">## [1] 252 779 483</span>
<span class="co">## [1] 985 562 989</span>
<span class="co">## [1] 744 956 578</span>
<span class="co">## [1] 236 738 483</span>
<span class="co">## [1] 351 699 415</span>
<span class="co">## [1] 360 304 121</span>
<span class="co">## [1] 744 889 304</span>
<span class="co">## [1] 740 304 254</span>
<span class="co">## [1] 740 121 345</span>
<span class="co">## [1] 751 339 528</span>
<span class="co">## [1] 252 740 147</span>
<span class="co">## [1] 368 578 252</span>
<span class="co">## [1] 252 904 320</span>
<span class="co">## [1] 394 744 368</span>
<span class="co">## [1] 254 740 920</span>
<span class="co">## [1] 283 338 733</span>
<span class="co">## [1] 252 904 236</span>
<span class="co">## [1] 236 252 819</span>
<span class="co">## [1] 252 819 904</span>
<span class="co">## [1] 780 622 841</span>
<span class="co">## [1] 162 581 284</span>
<span class="co">## [1] 166 516 918</span>
<span class="co">## [1] 162 505 860</span>
<span class="co">## [1] 841 976   3</span>
<span class="co">## [1] 162 930 860</span>
<span class="co">## [1] 581 493 162</span>
<span class="co">## [1] 581 493 162</span>
<span class="co">## [1] 992 841 780</span>
<span class="co">## [1] 581 493 604</span>
<span class="co">## [1] 581 493 162</span>
<span class="co">## [1] 581 493 604</span>
<span class="co">## [1] 581 493 604</span>
<span class="co">## [1] 581 493 162</span>
<span class="co">## [1] 992 780 622</span>
<span class="co">## [1] 127 246 841</span>
<span class="co">## [1] 581 493 162</span>
<span class="co">## [1] 581 493 162</span>
<span class="co">## [1] 941 210 176</span>
<span class="co">## [1] 581 493 604</span>
<span class="co">## [1] 976 224 814</span>
<span class="co">## [1] 581 162 493</span>
<span class="co">## [1] 162 346 284</span>
<span class="co">## [1] 246 224 635</span>
<span class="co">## [1] 841 976 224</span>
<span class="co">## [1] 581 162 604</span>
<span class="co">## [1] 505 860 162</span>
<span class="co">## [1] 581 604 493</span>
<span class="co">## [1] 992 780 682</span>
<span class="co">## [1] 992 461 465</span>
<span class="co">## [1] 877 510  80</span>
<span class="co">## [1]  18 309 853</span>
<span class="co">## [1] 309 679 916</span>
<span class="co">## [1] 992 949 682</span>
<span class="co">## [1] 992 682 458</span>
<span class="co">## [1] 458 949 127</span>
<span class="co">## [1] 495 568 425</span>
<span class="co">## [1] 533  40 599</span>
<span class="co">## [1] 992 461 313</span>
<span class="co">## [1] 628 309 949</span>
<span class="co">## [1] 992 682 841</span>
<span class="co">## [1] 992 682 949</span>
<span class="co">## [1] 992 461 881</span>
<span class="co">## [1] 992 949 682</span>
<span class="co">## [1] 478 306  31</span>
<span class="co">## [1]  40 425 533</span>
<span class="co">## [1] 992 313 461</span>
<span class="co">## [1] 313 679 461</span>
<span class="co">## [1] 992 461 186</span>
<span class="co">## [1] 992 881 959</span>
<span class="co">## [1] 949 682 679</span>
<span class="co">## [1] 313 461 679</span>
<span class="co">## [1]  18 461 701</span>
<span class="co">## [1] 992 949 682</span>
<span class="co">## [1] 628 309  18</span>
<span class="co">## [1] 628 281 342</span>
<span class="co">## [1] 825 533 381</span>
<span class="co">## [1] 949 992 679</span>
<span class="co">## [1] 872 916 214</span>
<span class="co">## [1] 992 682 574</span>
<span class="co">## [1] 313 992 679</span>
<span class="co">## [1] 309 628 949</span>
<span class="co">## [1]  18 800 582</span>
<span class="co">## [1] 992 682 458</span>
<span class="co">## [1] 701 679 572</span>
<span class="co">## [1] 604 162 212</span>
<span class="co">## [1] 604 686 610</span>
<span class="co">## [1] 258 808 749</span>
<span class="co">## [1] 857 128 209</span>
<span class="co">## [1] 128 745 209</span>
<span class="co">## [1] 604 581 493</span>
<span class="co">## [1] 604 162 284</span>
<span class="co">## [1] 502 646 749</span>
<span class="co">## [1] 604 284 212</span>
<span class="co">## [1] 786 939 478</span>
<span class="co">## [1]  51 761  48</span>
<span class="co">## [1] 604 284 686</span>
<span class="co">## [1] 252 320 904</span>
<span class="co">## [1] 604 241 610</span>
<span class="co">## [1] 745 635 814</span>
<span class="co">## [1] 604 162 581</span>
<span class="co">## [1] 814 749 502</span>
<span class="co">## [1] 502 857 749</span>
<span class="co">## [1] 369 100 954</span>
<span class="co">## [1] 976 405 814</span>
<span class="co">## [1] 604 581 493</span>
<span class="co">## [1] 604 212 638</span>
<span class="co">## [1] 745 635 814</span>
<span class="co">## [1] 604 212 638</span>
<span class="co">## [1] 145  46 100</span>
<span class="co">## [1] 604 284 686</span>
<span class="co">## [1] 610 688 604</span>
<span class="co">## [1] 646 479 502</span>
<span class="co">## [1] 230 212 638</span>
<span class="co">## [1] 604 581 241</span>
<span class="co">## [1] 878 478 785</span>
<span class="co">## [1] 369 954  48</span>
<span class="co">## [1] 604 241 581</span>
<span class="co">## [1] 405 814 976</span>
<span class="co">## [1] 252 128 904</span>
<span class="co">## [1] 162 493 604</span>
<span class="co">## [1] 995 693 902</span>
<span class="co">## [1] 192 352 242</span>
<span class="co">## [1] 252 512 770</span>
<span class="co">## [1] 667 452 611</span>
<span class="co">## [1] 479 675 865</span>
<span class="co">## [1] 121 740 905</span>
<span class="co">## [1] 242 192 697</span>
<span class="co">## [1] 266 904 931</span>
<span class="co">## [1] 572 961 161</span>
<span class="co">## [1] 928 494 407</span>
<span class="co">## [1] 252 320 904</span>
<span class="co">## [1] 479 931 675</span>
<span class="co">## [1]  18 905 342</span>
<span class="co">## [1] 452 611 995</span>
<span class="co">## [1] 995 478 611</span>
<span class="co">## [1] 995 352 452</span>
<span class="co">## [1] 770 512 675</span>
<span class="co">## [1] 342 512 121</span>
<span class="co">## [1] 252 675 147</span>
<span class="co">## [1] 675 147 865</span>
<span class="co">## [1] 304 905 740</span>
<span class="co">## [1] 907 995 906</span>
<span class="co">## [1] 452 352 611</span>
<span class="co">## [1] 640 658 637</span>
<span class="co">## [1] 251 995  46</span>
<span class="co">## [1] 192 611 510</span>
<span class="co">## [1] 905 770 121</span>
<span class="co">## [1] 479 147 865</span>
<span class="co">## [1] 252 904 675</span>
<span class="co">## [1] 252 147 479</span>
<span class="co">## [1] 582 572 512</span>
<span class="co">## [1] 581 493  38</span>
<span class="co">## [1]  38 329  16</span>
<span class="co">## [1] 794 492 204</span>
<span class="co">## [1]  69 553 735</span>
<span class="co">## [1]  69 315 428</span>
<span class="co">## [1] 492 337  14</span>
<span class="co">## [1] 399 678 670</span>
<span class="co">## [1] 574 315 735</span>
<span class="co">## [1]  34  24 684</span>
<span class="co">## [1] 574 622 735</span>
<span class="co">## [1] 553 288 204</span>
<span class="co">## [1] 574 852 315</span>
<span class="co">## [1] 428 288 337</span>
<span class="co">## [1] 866 511 776</span>
<span class="co">## [1] 919 554 130</span>
<span class="co">## [1] 581 329 285</span>
<span class="co">## [1]  38 184 866</span>
<span class="co">## [1] 581 885 285</span>
<span class="co">## [1] 919 130  34</span>
<span class="co">## [1] 574 622 828</span>
<span class="co">## [1] 581 670 324</span>
<span class="co">## [1]  38  16 721</span>
<span class="co">## [1] 581  38 670</span>
<span class="co">## [1] 116 511 866</span>
<span class="co">## [1] 634 735 431</span>
<span class="co">## [1] 622 741 735</span>
<span class="co">## [1] 915 670 827</span>
<span class="co">## [1] 622 769 815</span>
<span class="co">## [1] 622 735  47</span>
<span class="co">## [1]  69 428 492</span>
<span class="co">## [1] 622 741 735</span>
<span class="co">## [1] 827 678 399</span>
<span class="co">## [1] 670 827 915</span>
<span class="co">## [1]  16 656 531</span>
<span class="co">## [1] 670 324  38</span>
<span class="co">## [1] 735 622 741</span>
<span class="co">## [1] 581 493 329</span>
<span class="co">## [1] 204 288 337</span>
<span class="co">## [1] 622 741 735</span>
<span class="co">## [1] 428 237 315</span>
<span class="co">## [1] 574 622 828</span>
<span class="co">## [1] 581 329 285</span>
<span class="co">## [1] 826 521  50</span>
<span class="co">## [1] 704 546 668</span>
<span class="co">## [1] 704 680 546</span>
<span class="co">## [1] 314 948 521</span>
<span class="co">## [1] 775 377 519</span>
<span class="co">## [1] 775 314 948</span>
<span class="co">## [1] 828 574 634</span>
<span class="co">## [1] 775 519 377</span>
<span class="co">## [1] 775 655 948</span>
<span class="co">## [1] 546 917 704</span>
<span class="co">## [1] 775 948 314</span>
<span class="co">## [1] 574 828 465</span>
<span class="co">## [1] 546 534 704</span>
<span class="co">## [1] 590 839 806</span>
<span class="co">## [1] 948 314 775</span>
<span class="co">## [1]  76 441 513</span>
<span class="co">## [1] 183 250 420</span>
<span class="co">## [1] 828 894 574</span>
<span class="co">## [1] 630 917 404</span>
<span class="co">## [1] 718 221 375</span>
<span class="co">## [1] 221 250 375</span>
<span class="co">## [1] 753 669 726</span>
<span class="co">## [1] 861 806 852</span>
<span class="co">## [1] 322 779 320</span>
<span class="co">## [1] 606 470 131</span>
<span class="co">## [1] 779 322 483</span>
<span class="co">## [1] 554 935 654</span>
<span class="co">## [1] 288 337 475</span>
<span class="co">## [1] 320 322 252</span>
<span class="co">## [1] 142 923 131</span>
<span class="co">## [1] 322 320 398</span>
<span class="co">## [1] 322 320 779</span>
<span class="co">## [1] 320 322 779</span>
<span class="co">## [1] 320 322 398</span>
<span class="co">## [1] 184 866 116</span>
<span class="co">## [1] 320 322 252</span>
<span class="co">## [1] 579 758 325</span>
<span class="co">## [1] 322 779 483</span>
<span class="co">## [1] 469 713 833</span>
<span class="co">## [1] 691 623 610</span>
<span class="co">## [1] 142 923  29</span>
<span class="co">## [1] 923 398 419</span>
<span class="co">## [1] 184 329 436</span>
<span class="co">## [1] 322 536 779</span>
<span class="co">## [1] 204 553 288</span>
<span class="co">## [1] 288  70 782</span>
<span class="co">## [1] 623 241 632</span>
<span class="co">## [1] 581 493 329</span>
<span class="co">## [1] 703 146 708</span>
<span class="co">## [1] 322 779 483</span>
<span class="co">## [1] 131 142 237</span>
<span class="co">## [1] 322 779 536</span>
<span class="co">## [1] 923 322 398</span>
<span class="co">## [1] 419 923 619</span>
<span class="co">## [1] 178 923 322</span>
<span class="co">## [1] 215 444 115</span>
<span class="co">## [1] 322 779 536</span>
<span class="co">## [1] 632 866 526</span>
<span class="co">## [1] 288 475 204</span>
<span class="co">## [1] 322 178 398</span>
<span class="co">## [1] 469 632 589</span>
<span class="co">## [1] 142 131 895</span>
<span class="co">## [1] 322 779 483</span>
<span class="co">## [1] 236 738 216</span>
<span class="co">## [1] 779 322 937</span>
<span class="co">## [1] 697 826  92</span>
<span class="co">## [1] 292  50 534</span>
<span class="co">## [1]  50 289 447</span>
<span class="co">## [1] 723 580 893</span>
<span class="co">## [1] 252 322 779</span>
<span class="co">## [1] 252 322 320</span>
<span class="co">## [1] 322 779 483</span>
<span class="co">## [1] 937 779 787</span>
<span class="co">## [1] 1000  534  540</span>
<span class="co">## [1] 322 779 483</span>
<span class="co">## [1] 680 546 554</span>
<span class="co">## [1] 746 403 216</span>
<span class="co">## [1] 826 680  50</span>
<span class="co">## [1] 942 175 968</span>
<span class="co">## [1] 826  50  92</span>
<span class="co">## [1] 697 242 314</span>
<span class="co">## [1] 175 942 580</span>
<span class="co">## [1] 668 733 704</span>
<span class="co">## [1] 519 377 929</span>
<span class="co">## [1] 787 937 779</span>
<span class="co">## [1] 521 314 697</span>
<span class="co">## [1] 787 937 252</span>
<span class="co">## [1] 697 519 242</span>
<span class="co">## [1] 942 175 370</span>
<span class="co">## [1] 787 937 673</span>
<span class="co">## [1] 779 322 937</span>
<span class="co">## [1] 780 682 574</span>
<span class="co">## [1] 574 622 735</span>
<span class="co">## [1] 574 622 735</span>
<span class="co">## [1] 622 574 735</span>
<span class="co">## [1] 780 349 622</span>
<span class="co">## [1] 574 780 992</span>
<span class="co">## [1] 315 681 780</span>
<span class="co">## [1] 581 885 686</span>
<span class="co">## [1] 885 581 285</span>
<span class="co">## [1] 622 735 574</span>
<span class="co">## [1] 574 852 622</span>
<span class="co">## [1] 581 493 604</span>
<span class="co">## [1] 324 496 581</span>
<span class="co">## [1] 518  34 684</span>
<span class="co">## [1] 315 574 606</span>
<span class="co">## [1] 780 574 682</span>
<span class="co">## [1] 622 780 735</span>
<span class="co">## [1] 780 682 246</span>
<span class="co">## [1] 349 278 246</span>
<span class="co">## [1] 278 349 315</span>
<span class="co">## [1] 362 780  73</span>
<span class="co">## [1] 622 735 574</span>
<span class="co">## [1] 518 496 885</span>
<span class="co">## [1] 315 606 681</span>
<span class="co">## [1] 382 560 843</span>
<span class="co">## [1] 315 606 735</span>
<span class="co">## [1] 606 681 315</span>
<span class="co">## [1] 606 315  73</span>
<span class="co">## [1] 992 574 682</span>
<span class="co">## [1] 443 682 465</span>
<span class="co">## [1] 992 574 881</span>
<span class="co">## [1] 465 590 628</span>
<span class="co">## [1] 992 574 465</span>
<span class="co">## [1] 574 739 746</span>
<span class="co">## [1] 628 309 949</span>
<span class="co">## [1] 574 622 828</span>
<span class="co">## [1] 851 730 467</span>
<span class="co">## [1] 739 574 669</span>
<span class="co">## [1] 574 992 622</span>
<span class="co">## [1] 574 465 992</span>
<span class="co">## [1] 628 309 851</span>
<span class="co">## [1] 932 652 422</span>
<span class="co">## [1] 574 992 828</span>
<span class="co">## [1] 574 739 465</span>
<span class="co">## [1] 739 959 669</span>
<span class="co">## [1] 465 574  55</span>
<span class="co">## [1] 574 992 780</span>
<span class="co">## [1] 628 225 625</span>
<span class="co">## [1] 382 274 958</span>
<span class="co">## [1] 628 309 949</span>
<span class="co">## [1] 426 195 259</span>
<span class="co">## [1] 851 467 730</span>
<span class="co">## [1] 465 309 669</span>
<span class="co">## [1] 628 949 309</span>
<span class="co">## [1]  29 895 200</span>
<span class="co">## [1]  11 588 632</span>
<span class="co">## [1] 686 604 610</span>
<span class="co">## [1] 885 518 632</span>
<span class="co">## [1] 105  17 954</span>
<span class="co">## [1] 253 398 142</span>
<span class="co">## [1] 462 935 207</span>
<span class="co">## [1] 606 576 233</span>
<span class="co">## [1] 253 398 779</span>
<span class="co">## [1] 105  17 856</span>
<span class="co">## [1] 105 588  11</span>
<span class="co">## [1] 688 588 105</span>
<span class="co">## [1] 896 713 179</span>
<span class="co">## [1] 895 142  70</span>
<span class="co">## [1] 583 223 588</span>
<span class="co">## [1] 686 298 610</span>
<span class="co">## [1] 581 604 241</span>
<span class="co">## [1] 676 896 713</span>
<span class="co">## [1] 315 606  70</span>
<span class="co">## [1] 895 142 606</span>
<span class="co">## [1] 320 190  77</span>
<span class="co">## [1] 320 239  29</span>
<span class="co">## [1] 632 581 885</span>
<span class="co">## [1] 164 518 526</span>
<span class="co">## [1] 686 298 888</span>
<span class="co">## [1] 923 662 927</span>
<span class="co">## [1] 581 604 493</span>
<span class="co">## [1] 581 686 604</span>
<span class="co">## [1] 610 632 588</span>
<span class="co">## [1] 320 253 142</span>
<span class="co">## [1] 253 398 320</span>
<span class="co">## [1] 320 398 322</span>
<span class="co">## [1] 320 253 239</span>
<span class="co">## [1] 581 632 610</span>
<span class="co">## [1] 190  77 253</span>
<span class="co">## [1] 686 604 581</span>
<span class="co">## [1] 843 382 817</span>
<span class="co">## [1]  70 895 619</span>
<span class="co">## [1] 686 284 496</span>
<span class="co">## [1] 895 613 619</span>
<span class="co">## [1] 888 263  11</span>
<span class="co">## [1] 632 623 610</span>
<span class="co">## [1] 895  29 190</span>
<span class="co">## [1] 105 298  17</span>
<span class="co">## [1] 604 610 686</span>
<span class="co">## [1] 646  15 252</span>
<span class="co">## [1] 147 755 253</span>
<span class="co">## [1] 975 966 646</span>
<span class="co">## [1] 755  15 975</span>
<span class="co">## [1] 728 902 878</span>
<span class="co">## [1] 812 893 658</span>
<span class="co">## [1] 352 452 637</span>
<span class="co">## [1] 467 730 279</span>
<span class="co">## [1] 787 804 252</span>
<span class="co">## [1] 746 443 797</span>
<span class="co">## [1] 812 728 637</span>
<span class="co">## [1] 697 242 893</span>
<span class="co">## [1] 966 975 569</span>
<span class="co">## [1] 279 467 787</span>
<span class="co">## [1] 893 697 242</span>
<span class="co">## [1] 697 242 893</span>
<span class="co">## [1] 569 966 543</span>
<span class="co">## [1] 320  15 755</span>
<span class="co">## [1] 966 274 724</span>
<span class="co">## [1] 534 929 451</span>
<span class="co">## [1] 968 728 497</span>
<span class="co">## [1] 352 192 273</span>
<span class="co">## [1] 279 467 781</span>
<span class="co">## [1] 352 452 192</span>
<span class="co">## [1] 646 975 966</span>
<span class="co">## [1] 253 755 470</span>
<span class="co">## [1] 274 382  86</span>
<span class="co">## [1]  15 937 673</span>
<span class="co">## [1] 746 797 279</span>
<span class="co">## [1] 646  15 320</span>
<span class="co">## [1] 728 497 637</span>
<span class="co">## [1] 755 966  15</span>
<span class="co">## [1] 403 755 467</span>
<span class="co">## [1] 493 581  38</span>
<span class="co">## [1] 581  38 493</span>
<span class="co">## [1] 163 417 531</span>
<span class="co">## [1] 581 493  38</span>
<span class="co">## [1] 581  38 493</span>
<span class="co">## [1]  38 493  16</span>
<span class="co">## [1] 431 634 894</span>
<span class="co">## [1] 117 946 762</span>
<span class="co">## [1]  36 803 743</span>
<span class="co">## [1] 581 493 162</span>
<span class="co">## [1]  38 581 493</span>
<span class="co">## [1]  38  16 821</span>
<span class="co">## [1] 431 735  47</span>
<span class="co">## [1] 581  38 821</span>
<span class="co">## [1] 581  38 493</span>
<span class="co">## [1] 946 984  36</span>
<span class="co">## [1] 581 493 162</span>
<span class="co">## [1] 500 399 102</span>
<span class="co">## [1] 581 493  38</span>
<span class="co">## [1] 581 493 162</span>
<span class="co">## [1] 634 431 735</span>
<span class="co">## [1] 714 265   3</span>
<span class="co">## [1] 493 581  38</span>
<span class="co">## [1] 581 493  38</span>
<span class="co">## [1] 500 571 399</span>
<span class="co">## [1] 712 801 704</span>
<span class="co">## [1] 109 531 417</span>
<span class="co">## [1] 581 821  38</span>
<span class="co">## [1] 163 531  24</span>
<span class="co">## [1] 622 741 863</span>
<span class="co">## [1] 445 874 844</span>
<span class="co">## [1] 821 399 670</span>
<span class="co">## [1] 823 500  24</span>
<span class="co">## [1] 581 823  38</span>
<span class="co">## [1] 581 493  38</span>
<span class="co">## [1] 581 493  38</span>
<span class="co">## [1] 339 733 318</span>
<span class="co">## [1] 655 948 775</span>
<span class="co">## [1] 476 339  28</span>
<span class="co">## [1] 948 377 775</span>
<span class="co">## [1] 507 591 578</span>
<span class="co">## [1] 948 917 425</span>
<span class="co">## [1] 775 948 655</span>
<span class="co">## [1] 519 377 655</span>
<span class="co">## [1] 558 823 102</span>
<span class="co">## [1] 655 519 377</span>
<span class="co">## [1] 339 318 751</span>
<span class="co">## [1] 262 195  61</span>
<span class="co">## [1] 733 751 668</span>
<span class="co">## [1] 339 318 751</span>
<span class="co">## [1] 825 655 415</span>
<span class="co">## [1] 170 558  28</span>
<span class="co">## [1] 651  40 415</span>
<span class="co">## [1] 916 717 881</span>
<span class="co">## [1]  61 898 290</span>
<span class="co">## [1] 917 425 568</span>
<span class="co">## [1]  76 115 743</span>
<span class="co">## [1] 651 425 948</span>
<span class="co">## [1] 733 339 377</span>
<span class="co">## [1] 102 704 500</span>
<span class="co">## [1] 381 651 685</span>
<span class="co">## [1] 948 651 425</span>
<span class="co">## [1] 825 655 651</span>
<span class="co">## [1] 651 685 917</span>
<span class="co">## [1] 160 102 500</span>
<span class="co">## [1] 322 483 779</span>
<span class="co">## [1] 779 320 322</span>
<span class="co">## [1] 320 779 322</span>
<span class="co">## [1] 643 277 848</span>
<span class="co">## [1] 398 779 178</span>
<span class="co">## [1] 178 398 320</span>
<span class="co">## [1] 322 779 483</span>
<span class="co">## [1] 434 178 627</span>
<span class="co">## [1] 320 322 779</span>
<span class="co">## [1] 178 398 320</span>
<span class="co">## [1] 779 322 483</span>
<span class="co">## [1] 483 779 236</span>
<span class="co">## [1] 322 779 252</span>
<span class="co">## [1] 178 398 779</span>
<span class="co">## [1] 483 236 779</span>
<span class="co">## [1] 779 322 483</span>
<span class="co">## [1] 178 322 398</span>
<span class="co">## [1] 322 178 398</span>
<span class="co">## [1] 320 322 779</span>
<span class="co">## [1] 295 204 743</span>
<span class="co">## [1] 779 322 131</span>
<span class="co">## [1] 295 204 743</span>
<span class="co">## [1] 779 322 483</span>
<span class="co">## [1] 779 483 398</span>
<span class="co">## [1] 320 322 779</span>
<span class="co">## [1] 178 779 398</span>
<span class="co">## [1] 325 550 408</span>
<span class="co">## [1] 295 507 779</span>
<span class="co">## [1] 398 779 178</span>
<span class="co">## [1] 178 320 398</span>
<span class="co">## [1] 483 779 322</span>
<span class="co">## [1] 779 483 398</span>
<span class="co">## [1] 252 779 322</span>
<span class="co">## [1] 779 483 322</span>
<span class="co">## [1] 893 697 242</span>
<span class="co">## [1] 779 322 483</span>
<span class="co">## [1] 216 483 236</span>
<span class="co">## [1] 368 551 361</span>
<span class="co">## [1] 252 787 779</span>
<span class="co">## [1] 779 483 398</span>
<span class="co">## [1] 408 654 447</span>
<span class="co">## [1] 647 747 283</span>
<span class="co">## [1] 262 508 290</span>
<span class="co">## [1] 733 751 283</span>
<span class="co">## [1] 655 697 242</span>
<span class="co">## [1] 507 578 295</span>
<span class="co">## [1]  76 578 473</span>
<span class="co">## [1] 740 269 268</span>
<span class="co">## [1] 473 578  35</span>
<span class="co">## [1] 366 316 695</span>
<span class="co">## [1] 368 578 473</span>
<span class="co">## [1] 740 254 269</span>
<span class="co">## [1] 252 779 483</span>
<span class="co">## [1] 740 254 269</span>
<span class="co">## [1] 346 558  28</span>
<span class="co">## [1] 844 714 161</span>
<span class="co">## [1] 362  73 382</span>
<span class="co">## [1]  31 346 953</span>
<span class="co">## [1] 581 493 162</span>
<span class="co">## [1] 581 162 493</span>
<span class="co">## [1] 478 346  31</span>
<span class="co">## [1] 581 493 162</span>
<span class="co">## [1] 162 284 581</span>
<span class="co">## [1] 581 493 162</span>
<span class="co">## [1]   3 410  73</span>
<span class="co">## [1]  31 346 953</span>
<span class="co">## [1] 581 493 604</span>
<span class="co">## [1] 581 162 821</span>
<span class="co">## [1] 346 953 111</span>
<span class="co">## [1] 823 792  28</span>
<span class="co">## [1] 581 821 324</span>
<span class="co">## [1] 162 581 493</span>
<span class="co">## [1] 581 493 162</span>
<span class="co">## [1] 965 963  96</span>
<span class="co">## [1] 581  38 821</span>
<span class="co">## [1] 581 604 162</span>
<span class="co">## [1] 581 792 162</span>
<span class="co">## [1] 558  28 823</span>
<span class="co">## [1] 581 162 823</span>
<span class="co">## [1] 992 431 828</span>
<span class="co">## [1]  30 101 947</span>
<span class="co">## [1] 445 653 780</span>
<span class="co">## [1] 581 493 329</span>
<span class="co">## [1] 581 162 493</span>
<span class="co">## [1] 162 581 493</span>
<span class="co">## [1]  28 621 823</span>
<span class="co">## [1] 581 493 162</span>
<span class="co">## [1] 581  38 792</span>
<span class="co">## [1] 410 682  73</span>
<span class="co">## [1] 669 465 739</span>
<span class="co">## [1] 628 309 195</span>
<span class="co">## [1] 682 410 265</span>
<span class="co">## [1] 628 225 106</span>
<span class="co">## [1] 628 309 949</span>
<span class="co">## [1] 949 509 679</span>
<span class="co">## [1] 196 655 825</span>
<span class="co">## [1] 949 682 509</span>
<span class="co">## [1] 682 949 509</span>
<span class="co">## [1] 992 682 780</span>
<span class="co">## [1] 679 916 799</span>
<span class="co">## [1] 957 476 451</span>
<span class="co">## [1] 309 916 679</span>
<span class="co">## [1] 198 962 381</span>
<span class="co">## [1] 825 381 962</span>
<span class="co">## [1] 309 916 669</span>
<span class="co">## [1] 476 377 519</span>
<span class="co">## [1] 655 519 196</span>
<span class="co">## [1] 694 667 333</span>
<span class="co">## [1] 111 953 346</span>
<span class="co">## [1] 959 881 992</span>
<span class="co">## [1] 962 487 138</span>
<span class="co">## [1] 959 739 682</span>
<span class="co">## [1] 309 628 465</span>
<span class="co">## [1] 825 655 196</span>
<span class="co">## [1] 198 333 118</span>
<span class="co">## [1] 443 575 238</span>
<span class="co">## [1] 688 610 588</span>
<span class="co">## [1] 581 604 493</span>
<span class="co">## [1] 688 588 954</span>
<span class="co">## [1] 610 581 686</span>
<span class="co">## [1] 581 632 610</span>
<span class="co">## [1] 621 478 446</span>
<span class="co">## [1] 610 688 632</span>
<span class="co">## [1] 320 252 779</span>
<span class="co">## [1] 688 878 284</span>
<span class="co">## [1] 493 331 241</span>
<span class="co">## [1] 676 953  28</span>
<span class="co">## [1] 238 206 435</span>
<span class="co">## [1] 686 284 604</span>
<span class="co">## [1] 581 632 493</span>
<span class="co">## [1] 320 253 239</span>
<span class="co">## [1] 164 676 621</span>
<span class="co">## [1] 162 331 604</span>
<span class="co">## [1] 662 767  19</span>
<span class="co">## [1] 698 844 206</span>
<span class="co">## [1] 610 604 241</span>
<span class="co">## [1] 470 238 253</span>
<span class="co">## [1] 688 610 686</span>
<span class="co">## [1]  72  19 239</span>
<span class="co">## [1] 621 162  28</span>
<span class="co">## [1] 162 331 581</span>
<span class="co">## [1] 610 632 581</span>
<span class="co">## [1] 740 147 254</span>
<span class="co">## [1] 196 655 242</span>
<span class="co">## [1] 252 147 675</span>
<span class="co">## [1] 316 611 366</span>
<span class="co">## [1] 958 730 281</span>
<span class="co">## [1] 640 658 928</span>
<span class="co">## [1] 106 225 625</span>
<span class="co">## [1] 697 242 893</span>
<span class="co">## [1] 196 697 242</span>
<span class="co">## [1] 962 487 945</span>
<span class="co">## [1] 996 446 945</span>
<span class="co">## [1] 345 439 631</span>
<span class="co">## [1] 519 695 893</span>
<span class="co">## [1] 611 196 192</span>
<span class="co">## [1] 878 902  31</span>
<span class="co">## [1] 512 770 730</span>
<span class="co">## [1] 575 443 238</span>
<span class="co">## [1] 235 730 268</span>
<span class="co">## [1] 196 519 655</span>
<span class="co">## [1]  66 339 621</span>
<span class="co">## [1] 192 196 242</span>
<span class="co">## [1] 740 147 254</span>
<span class="co">## [1] 147 646 675</span>
<span class="co">## [1] 675 147 865</span>
<span class="co">## [1] 631 205 468</span>
<span class="co">## [1] 728 637 658</span>
<span class="co">## [1] 452 352 658</span>
<span class="co">## [1] 205 269 544</span>
<span class="co">## [1] 147 675 865</span>
<span class="co">## [1] 268 238 235</span>
<span class="co">## [1] 962 138 487</span>
<span class="co">## [1] 995 478 138</span>
<span class="co">## [1] 759 235 958</span>
<span class="co">## [1] 238 268 575</span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">for</span><span class="op">(</span><span class="va">iter</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span><span class="op">{</span>
    <span class="va">.mu.ds</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">.ybar.ds</span> <span class="op">+</span> <span class="va">.zbar.ds</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">.delta.db</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">.prob.bs</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>
    <span class="va">.delta.db</span> <span class="op">&lt;-</span> <span class="va">.delta.num.db</span> <span class="op">/</span> <span class="op">(</span><span class="va">.mu.ds</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">.size.bs</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1e-8</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Can we recover the original batch effects?</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">.delta.db</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">W.true</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, pch<span class="op">=</span><span class="fl">19</span>, xlab<span class="op">=</span><span class="st">"estimated delta"</span>, ylab<span class="op">=</span><span class="st">"true delta effect"</span>, main<span class="op">=</span><span class="st">"batch1"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">.delta.db</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, <span class="va">W.true</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, pch<span class="op">=</span><span class="fl">19</span>, xlab<span class="op">=</span><span class="st">"estimated delta"</span>, ylab<span class="op">=</span><span class="st">"true delta effect"</span>, main<span class="op">=</span><span class="st">"batch2"</span><span class="op">)</span></code></pre></div>
<p><img src="note_batch_correction_files/figure-html/unnamed-chunk-7-1.png" width="576"></p>
<p>Are they independent of the cell type effects?</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">y.true</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sweep.html" class="external-link">sweep</a></span><span class="op">(</span><span class="va">lambda.true</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">X</span>, <span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="va">`/`</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">.delta.db</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">y.true</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, pch<span class="op">=</span><span class="fl">19</span>, xlab<span class="op">=</span><span class="st">"estimated delta"</span>, ylab<span class="op">=</span><span class="st">"true y mean"</span>, main<span class="op">=</span><span class="st">"batch1"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">.delta.db</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, <span class="va">y.true</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, pch<span class="op">=</span><span class="fl">19</span>, xlab<span class="op">=</span><span class="st">"estimated delta"</span>, ylab<span class="op">=</span><span class="st">"true y mean"</span>, main<span class="op">=</span><span class="st">"batch2"</span><span class="op">)</span></code></pre></div>
<p><img src="note_batch_correction_files/figure-html/unnamed-chunk-8-1.png" width="576"></p>
<p>While adjusting the estimated batch effects, can we recover the unbiased cell type effects? The following is before adjustment:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ybar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sweep.html" class="external-link">sweep</a></span><span class="op">(</span><span class="va">yy</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">X</span>, <span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="va">`/`</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ybar</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">y.true</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, pch<span class="op">=</span><span class="fl">19</span>, xlab<span class="op">=</span><span class="st">"sample mean"</span>, ylab<span class="op">=</span><span class="st">"true y mean"</span>, log<span class="op">=</span><span class="st">"x"</span>, main<span class="op">=</span><span class="st">"batch1"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ybar</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, <span class="va">y.true</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, pch<span class="op">=</span><span class="fl">19</span>, xlab<span class="op">=</span><span class="st">"sample mean"</span>, ylab<span class="op">=</span><span class="st">"true y mean"</span>, log<span class="op">=</span><span class="st">"x"</span>, main<span class="op">=</span><span class="st">"batch2"</span><span class="op">)</span></code></pre></div>
<p><img src="note_batch_correction_files/figure-html/unnamed-chunk-9-1.png" width="576"></p>
<p>Here, we adjusted the batch effects:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ybar.adj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sweep.html" class="external-link">sweep</a></span><span class="op">(</span><span class="op">(</span><span class="va">yy</span> <span class="op">/</span> <span class="va">.delta.db</span><span class="op">[</span>, <span class="va">batch</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">X</span>, <span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="va">`/`</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ybar.adj</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">y.true</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, pch<span class="op">=</span><span class="fl">19</span>, xlab<span class="op">=</span><span class="st">"adjusted sample mean"</span>, ylab<span class="op">=</span><span class="st">"true y mean"</span>, log<span class="op">=</span><span class="st">"x"</span>, main<span class="op">=</span><span class="st">"batch1"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ybar.adj</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, <span class="va">y.true</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, pch<span class="op">=</span><span class="fl">19</span>, xlab<span class="op">=</span><span class="st">"adjusted sample mean"</span>, ylab<span class="op">=</span><span class="st">"true y mean"</span>, log<span class="op">=</span><span class="st">"x"</span>, main<span class="op">=</span><span class="st">"batch2"</span><span class="op">)</span></code></pre></div>
<p><img src="note_batch_correction_files/figure-html/unnamed-chunk-10-1.png" width="576"></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="va">.umap</span> <span class="op">&lt;-</span> <span class="fu">uwot</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/uwot/man/umap.html" class="external-link">umap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">yy</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">.umap</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">.umap</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, col<span class="op">=</span><span class="va">batch</span>, pch<span class="op">=</span><span class="fl">19</span>, cex<span class="op">=</span><span class="fl">.5</span>, main<span class="op">=</span><span class="st">"before batch adj"</span>,
     xlab <span class="op">=</span> <span class="st">"umap1"</span>, ylab <span class="op">=</span> <span class="st">"umap2"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topleft"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"batch #1"</span>, <span class="st">"batch #2"</span><span class="op">)</span>, col<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, pch<span class="op">=</span><span class="fl">19</span><span class="op">)</span>
<span class="va">.umap</span> <span class="op">&lt;-</span> <span class="fu">uwot</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/uwot/man/umap.html" class="external-link">umap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">yy</span><span class="op">/</span><span class="va">.delta.db</span><span class="op">[</span>,<span class="va">batch</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">.umap</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">.umap</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, col<span class="op">=</span><span class="va">batch</span>, pch<span class="op">=</span><span class="fl">19</span>, cex<span class="op">=</span><span class="fl">.5</span>, main<span class="op">=</span><span class="st">"after batch adj"</span>,
     xlab <span class="op">=</span> <span class="st">"umap1"</span>, ylab <span class="op">=</span> <span class="st">"umap2"</span><span class="op">)</span></code></pre></div>
<p><img src="note_batch_correction_files/figure-html/unnamed-chunk-11-1.png" width="576"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Yongjin Park, Sishir Subedi.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
