---
title: "ASAP: Annotating Single-cell data by Approximate Pseduobulk projection"
author: "Sishir Subedi and Yongjin P Park"
---

## Can we approximate NMF for single-cell data anlaysis?

Let's generate some single cell data.

$$Y_{ij} \sim \operatorname{Poisson}(\mu_{it} \rho_{j})$$

where

* $\mu_{it}$: expression pattern for a gene $i$ within a cell type $t$

* $\rho_{j}$: sampling depth for a cell $j$

```{r}
library(asapR)
set.seed(42)

.rnorm <- function(d1,d2) matrix(rnorm(d1*d2), d1, d2)
.zero <- function(d1,d2) matrix(rep(0, d1*d2), d1, d2)

mtx.data <- fileset.list("temp")

ntypes <- 5
ngenes <- 10000
ncells <- 3000
nanchor <- 100 ## anchor genes 

.anchors <- NULL
.beta <- .zero(ngenes, ntypes)
for(tt in 1:ntypes){
    .anchor.t <- sample(ngenes, nanchor)
    .beta[.anchor.t,tt] <- .rnorm(nanchor, 1) * 2
    .anchors <- c(.anchors, .anchor.t)
}
.beta <- .beta + .rnorm(ngenes, ntypes)
.membership <- sample(ntypes, ncells, replace=TRUE)
.theta <- Matrix::spMatrix(nrow=ntypes, ncol=ncells, i = .membership, j = 1:ncells, x = rep(1, ncells))

X <- apply(.beta %*% .theta, 2, scale) * sqrt(.5) + .rnorm(ngenes, ncells) * sqrt(.5)
X <- round(Matrix::Matrix(exp(X), sparse=TRUE))

## must remove the index file if it exists
## unlink("temp.mtx.gz")
## unlink("temp.mtx.gz.index")
## mtx.data <- write.sparse(X, 1:ngenes, 1:ncells, "temp")

Y <- read.mtx.dense(mtx.data$mtx)

.out <- asap_fit_nmf_susie(Y, 7);

zz <- .out$theta[order(.membership), ]

heatmap(zz, Rowv=NA)

```






Since this data set is small enough, we can read them all in the memory and conduct some exploratory analysis. However, it may not be so for a large single-cell data set which may contain tens of thousands of features over millions of cells. We can estimate top PCs to figure out some latent structures:

```{r}
library(ggplot2)
library(dplyr)
library(patchwork)
theme_set(theme_bw())

Y <- read.mtx.dense(mtx.data$mtx)
cells <- read.table(mtx.data$col)
.svd <- svd(log(Y + 1), 3, 3) # gene x factor, cell x factor
colnames(.svd$v) <- paste0("PC", 1:ncol(.svd$v)) # cell x factor

annot <- data.frame(V1=1:ncells, V2=as.factor(.membership))
```

```{r fig.width=8, fig.height=3}
.df <- as_tibble(.svd$v) %>%
    cbind(cells) %>% 
    left_join(annot)

p1 <- ggplot(.df, aes(PC1, PC2, fill=`V2`)) +
    geom_point(stroke=.1, pch=21) +
    scale_fill_brewer("membership",palette="Paired")

p2 <- ggplot(.df, aes(PC2, PC3, fill=`V2`)) +
    geom_point(stroke=.1, pch=21) +
    scale_fill_brewer("membership",palette="Paired")

p1 | p2
```


```{r}
.asap <- fit.topic.asap(mtx.data$mtx,
                        k=7,
                        pb.factors = 10,
                        num.proj = 1,
                        em.step = 1000,
                        e.step = 1,
                        verbose=FALSE,
                        num.threads=8)

## .fqtl <- fqtl::fit.fqtl.factorize(Y, k = 7, model="nb",
##                                   options.mf=list(resid.out=FALSE))

theta.hat <- .asap$prop

rownames(theta.hat) <- readLines(mtx.data$col)
colnames(theta.hat) <- 1:ncol(theta.hat)

.annot <- data.frame(V1=1:ncells, V2=as.factor(.membership))
.order <- rownames(theta.hat)[order(apply(.asap$prop, 1, function(x) which.max(x)))]

.df <-
    reshape2::melt(theta.hat) %>%
    mutate(V1 = as.integer(`Var1`)) %>% 
    left_join(.annot, by = "V1") %>%
    mutate(k = as.factor(Var2)) %>% 
    mutate(x = factor(Var1, .order))

ggplot(.df, aes(x, value, fill=k)) +
    theme_void() +
    facet_grid(.~V2, space="free", scales="free") +
    geom_bar(stat="identity", position="stack") +
    scale_fill_brewer("cell type", palette = "Paired")

```


```{r}

.umap <- uwot::umap(.asap$corr,
                    fast_sgd=TRUE, n_threads = 8)

colnames(.umap) <- paste0("umap", 1:ncol(.umap))
.umap.df <- data.frame(.umap, k=as.factor(.membership))

ggplot(.umap.df, aes(umap1, umap2, color=k)) +
    geom_point()

```




```{r}
.svd <- rsvd::rsvd(log(Y + 1), 50)

.umap <- uwot::umap(.svd$v, fast_sgd=TRUE, n_threads = 8)

colnames(.umap) <- paste0("umap", 1:ncol(.umap))
.umap.df <- data.frame(.umap, k=as.factor(.membership))

ggplot(.umap.df, aes(umap1, umap2, color=k)) +
    geom_point()

```
